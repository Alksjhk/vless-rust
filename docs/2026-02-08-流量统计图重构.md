# 流量统计图重构

**日期**: 2026-02-08  
**类型**: 重构 (refactor)

## 概述

重新构建前端流量统计图部分，优化组件结构、提升性能和改进用户体验。

## 主要变更

### 1. 组件整合

**删除**:
- `frontend/src/components/TrafficChart.jsx` - 旧的流量图表组件

**优化**:
- `frontend/src/components/charts/SpeedChart.jsx` - 统一的速度趋势图组件
- `frontend/src/components/charts/TrafficChartSection.jsx` - 图表容器组件

### 2. 功能改进

#### SpeedChart 组件
- ✅ 支持面积图和折线图切换（通过 `showArea` 属性）
- ✅ 动态 Y 轴范围计算，自动适应数据规模
- ✅ 优化的 X 轴刻度显示（首、中、尾三个时间点）
- ✅ 改进的 Tooltip 交互体验
- ✅ 使用 CSS 变量适配主题（亮色/暗色模式）
- ✅ 性能优化：使用 `memo` 和 `useMemo` 减少重渲染

#### TrafficChartSection 组件
- ✅ 新增连接状态指示器（WebSocket/API 轮询/连接中）
- ✅ 显示历史数据时长
- ✅ 使用 Badge 组件美化状态显示
- ✅ 动画效果：WebSocket 连接时的脉冲动画

### 3. 工具函数优化

**chartHelpers.js** 新增功能:
- `calculateYAxisMax()` - 智能计算 Y 轴最大值
- `generateXAxisTicks()` - 生成合适的 X 轴刻度
- `chartTheme` - 统一的图表主题配置
- 改进的 `formatSpeed()` - 更精确的速度格式化

### 4. 视觉改进

- 🎨 使用渐变填充增强视觉效果
- 🎨 网格线使用虚线样式，降低视觉干扰
- 🎨 Tooltip 样式适配主题系统
- 🎨 图例使用方形符号，更清晰
- 🎨 连接状态指示器带动画效果

### 5. 响应式修复

- ✅ 修复流量图尺寸问题
- ✅ 添加容器宽度监听（使用 `ResizeObserver`）
- ✅ 图表宽度自动适应容器
- ✅ 窗口大小变化时自动重新计算宽度

## 技术细节

### 数据流
```
monitorStore (speedHistory)
    ↓
TrafficChartSection (容器 + 状态显示)
    ↓
SpeedChart (图表渲染)
```

### 性能优化
1. **memo 包裹组件**：避免不必要的重渲染
2. **useMemo 缓存计算**：
   - 数据格式转换
   - Y 轴最大值计算
   - X 轴刻度生成
3. **禁用动画**：Victory 图表动画在实时数据场景下会影响性能

### 主题适配
使用 CSS 变量实现主题切换：
```javascript
fill: 'hsl(var(--foreground))'
stroke: 'hsl(var(--border))'
```

## 构建结果

```
TrafficChartSection-B_F8or90.js    5.04 kB │ gzip: 2.18 kB
chart-vendor-DecMr12B.js         293.91 kB │ gzip: 93.94 kB
```

- 图表组件体积优化
- 代码分割良好
- Gzip 压缩率高

## 向后兼容性

✅ 完全兼容现有 API
- 数据格式不变
- Store 接口不变
- 组件 props 向后兼容

## 测试

- ✅ 编译检查通过
- ✅ 构建成功
- ✅ 无 TypeScript/ESLint 错误

## 后续优化建议

1. **数据采样**：当历史数据点过多时（>200），可以考虑采样显示
2. **缩放功能**：添加图表缩放和平移功能
3. **导出功能**：支持导出图表为图片
4. **多时间范围**：支持切换 1 分钟/5 分钟/30 分钟视图

## 相关文件

- `frontend/src/components/charts/SpeedChart.jsx`
- `frontend/src/components/charts/TrafficChartSection.jsx`
- `frontend/src/utils/chartHelpers.js`
- `frontend/src/store/monitorStore.js`

---

## 2026-02-08 更新：固定时间窗口显示

### 问题描述

刚启动时，流量趋势图的时间轴会逐渐从右往左推出，导致时间轴不够固定，用户体验不佳。

### 解决方案

修改图表数据转换逻辑，实现固定的2分钟（120秒）时间窗口：

**修改文件**: `frontend/src/components/charts/SpeedChart.jsx`

#### 核心变更

1. **固定槽位设计**：
   - 从动态数据点改为固定120个槽位（120秒）
   - 每个槽位代表1秒，从"当前时间-119秒"到"当前时间"
   - 缺失数据点的速度自动填充为0

2. **数据映射逻辑**：
   - 以最新数据点的时间戳作为基准（或使用当前时间）
   - 构建120个时间槽位，查找每个槽位对应的历史数据
   - 未匹配到数据的槽位显示0速度

3. **X轴刻度固定**：
   - 在固定120个槽位上均匀分布10个刻度
   - 时间轴始终保持稳定，不随数据量变化

### 技术实现

```javascript
// 固定120个槽位（120秒）
const FIXED_SLOTS = 120
const latestTimestamp = parseInt(speedHistory[speedHistory.length - 1].timestamp)

// 构建时间窗口
for (let i = 0; i < FIXED_SLOTS; i++) {
  const slotTimestamp = latestTimestamp - (FIXED_SLOTS - 1 - i)
  const matchedData = speedHistory.find(item => parseInt(item.timestamp) === slotTimestamp)

  fixedSlots.push({
    x: i,
    time: formatTime(slotTimestamp),
    upload: parseSpeedString(matchedData?.upload_speed || '0 B/s'),
    download: parseSpeedString(matchedData?.download_speed || '0 B/s'),
    timestamp: slotTimestamp
  })
}
```

### 效果

- ✅ 刚启动时就显示完整的2分钟时间窗口
- ✅ 缺失数据的时间段速度为0，预留空间
- ✅ 时间轴固定，不会逐渐推出
- ✅ 随着数据累积，从右向左填充图表
- ✅ 视觉体验更加稳定和直观
