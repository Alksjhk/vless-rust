# 2026.02.02 - HTTP监控页面与实时数据推送

## 新增功能

### 后端模块
- **HTTP 服务器** (src/http.rs)
  - 混合协议监听，支持在同一端口处理 VLESS 和 HTTP 请求
  - 静态文件服务，支持嵌入式静态资源（rust-embed）
  - RESTful API 端点，提供监控数据查询接口

- **流量统计模块** (src/stats.rs)
  - 实时速度计算，使用快照机制确保精度
  - 60秒历史数据存储，支持趋势图表
  - 每10分钟自动持久化到配置文件
  - 系统资源监控（内存、连接数）

- **WebSocket 实时推送** (src/ws.rs)
  - 每秒广播监控数据到所有连接的客户端
  - 支持最大100个并发 WebSocket 连接
  - 60秒心跳超时检测，自动清理死连接
  - WebSocket 握手协议实现

### 前端监控页面
- **现代化 UI 设计** (frontend/)
  - Vue 3 Composition API
  - Vite 构建工具（使用 rolldown-vite 优化）
  - 响应式设计，适配桌面、平板、移动设备
  - 深色/浅色主题切换，支持 localStorage 持久化

- **实时数据展示**
  - 实时传输速度卡片（上传/下载）
  - 总流量使用量统计
  - 服务器运行时长
  - 内存占用显示
  - 活动连接数监控
  - Canvas 绘制的实时波形图，支持鼠标悬停查看详细数据

- **智能降级机制**
  - WebSocket 连接失败时自动切换到 API 轮询模式
  - 确保监控页面在各种网络环境下可用

### 配置与部署
- **新增配置项** (config.json)
  - `monitoring.speed_history_duration`: 历史数据保留时长（秒）
  - `monitoring.broadcast_interval`: WebSocket 广播间隔（秒）
  - `monitoring.websocket_max_connections`: WebSocket 最大连接数
  - `monitoring.websocket_heartbeat_timeout`: WebSocket 心跳超时（秒）
  - `monitoring.vless_max_connections`: VLESS 最大连接数
  - `monitor`: 自动维护的流量统计数据

- **单文件部署**
  - 使用 rust-embed 将前端静态资源嵌入可执行文件
  - 编译后约 814KB，无需额外静态资源目录
  - 简化部署流程，单文件即可运行

## 技术更新

### 依赖项变更
新增依赖：
- `tokio-tungstenite`: WebSocket 协议支持
- `futures-channel/futures-util`: 异步流处理
- `sysinfo`: 系统信息监控
- `chrono`: 时间处理
- `rust-embed`: 静态资源嵌入

### 架构优化
- VLESS 服务器集成流量统计和 HTTP 请求处理
- 连接数管理使用 RAII 模式，确保异常安全
- 使用 Arc<RwLock> 实现 WebSocket 连接池并发访问
- 配置文件结构扩展，支持监控相关参数

### 文档更新
- 新增 CLAUDE.md 项目文档
- 新增 docs/ 技术文档目录
- README.md 更新前端使用说明、监控功能介绍、部署指南

## 修改文件

- `.gitignore`: 添加前端构建产物和开发工具忽略项
- `Cargo.toml`: 添加新依赖项
- `README.md`: 更新使用说明，添加监控页面功能介绍
- `config.json`: 添加 monitoring 和 monitor 配置项
- `src/config.rs`: 添加 MonitoringConfig 结构体
- `src/main.rs`: 集成统计、HTTP、WebSocket 模块初始化
- `src/server.rs`: 集成 HTTP 请求检测、流量统计、连接管理

## 新增文件

- `CLAUDE.md`: 项目文档
- `docs/`: 技术文档目录
- `frontend/`: Vue 3 前端项目（包含源码、配置、构建产物）
- `src/http.rs`: HTTP 服务器模块
- `src/stats.rs`: 流量统计模块
- `src/ws.rs`: WebSocket 实时推送模块
