# 2026-02-03 TLS证书生成和初始化向导优化

## 变更概述

本次更新主要优化了 TLS 证书生成流程和初始化配置体验，实现了以下功能：

### ✨ 新增功能

#### 1. 初始化配置向导
- 首次运行时自动启动交互式配置向导
- 引导用户完成以下配置：
  - **端口配置**（默认 8443）
  - **UUID 配置**（自动生成或手动输入）
  - **TLS 配置**：
    - 启用/禁用 TLS
    - 设置服务器域名/SNI（默认 localhost）
    - 自动生成自签名证书

#### 2. TLS 证书自动生成
- 证书文件不存在时自动生成
- 证书有效期：**10 年（3650 天）**
- 完整的 SAN 配置：
  - 配置的 `server_name`
  - `localhost`
  - `*.local`（通配符域名）
  - `127.0.0.1`（IPv4 回环地址）
  - `::1`（IPv6 回环地址）
- 证书文件持久保存，程序重启不会重新生成（除非文件被删除）

#### 3. VLESS 连接 URL 自动生成
- 启动时自动生成 VLESS 连接 URL
- 格式：`vless://uuid@server:port?security=none|tls&type=tcp&encryption=none&flow=&sni=server&alpn=h2,http/1.1#email`
- 自签名证书模式自动添加 `allowInsecure=true` 参数（v2rayN 需要导入后手动设置）
- 控制台打印连接信息，方便用户复制
- URL 保存到 `config.json` 的 `vless_url` 字段

### 🔧 配置简化

#### 移除 `mode` 字段
- 之前：区分 `file` 和 `embedded` 模式
- 现在：统一使用文件模式，证书不存在时自动生成
- 简化了配置结构和代码逻辑

#### 新增配置项
```json
{
  "tls": {
    "enabled": true,
    "cert_file": "certs/server.crt",
    "key_file": "certs/server.key",
    "server_name": "localhost"
  },
  "vless_url": "vless://uuid@server:port?security=tls&type=tcp#email"
}
```

### 📝 文件变更

#### 新增文件
- `src/tls.rs` - TLS 配置加载、证书生成和握手处理
- `src/wizard.rs` - 初始化配置向导模块
- `docs/2026-02-03-TLS证书生成和初始化向导优化.md` - 本更新日志

#### 修改文件
- `src/main.rs` - 集成初始化向导和 VLESS URL 打印
- `src/config.rs` - 添加 `vless_url` 字段和 `generate_vless_url()` 方法
- `src/server.rs` - TLS 握手处理和协议检测
- `Cargo.toml` - 升级 rcgen 到 0.14，新增 time 依赖
- `CLAUDE.md` - 更新项目架构和文件映射
- `README.md` - 添加 TLS 配置说明和使用指南
- `docs/technology.md` - 更新 TLS 模块说明
- `plan.md` - 标记 TLS 功能为已完成

#### 删除文件
- `src/bin/gen_cert.rs` - 独立证书生成工具（功能集成到主程序）

### 🎯 使用说明

#### 首次运行
```bash
./vless

# 初始化向导会：
# 1. 设置端口（默认 8443）
# 2. 设置 UUID（自动生成或手动输入）
# 3. 配置 TLS：
#    - 启用/禁用
#    - 输入服务器域名/SNI（默认 localhost）
#    - 自动生成自签名证书到 certs/ 目录
```

#### 启动时自动处理
- 如果证书文件存在，直接加载
- 如果证书文件不存在，自动生成
- 无需手动执行证书生成命令

#### 控制台输出
```
╔════════════════════════════════════════════════════════════╗
║              VLESS Rust 服务器已启动                      ║
╚════════════════════════════════════════════════════════════╝

📋 服务器信息:
  监听地址: 0.0.0.0:8443
  TLS 状态: 启用
  证书文件: certs/server.crt
  服务器名称: localhost
  用户数量: 1

🔗 VLESS 连接 URL:
  ┌─────────────────────────────────────────────────────────┐
  │ vless://uuid@127.0.0.1:8443?security=tls&encryption=... │
  └─────────────────────────────────────────────────────────┘

  💡 提示: 复制上方 URL 到 VLESS 客户端即可连接

📊 监控面板:
  http://0.0.0.0:8443/

按 Ctrl+C 停止服务器
```

### 🔒 安全性

- 自签名证书仅用于测试/开发
- 生产环境建议使用正规 CA 签发的证书
- 可手动替换证书文件，程序会自动加载
- 私钥文件权限应设置为仅所有者可读写（`chmod 600 certs/server.key`）

### 📚 技术细节

#### 证书自动生成
- 使用 `rcgen` 0.14 的 `CertificateParams` 手动配置
- PEM 格式保存到文件
- 使用 `time` 0.3 设置证书有效期

#### 协议检测
通过检测 TCP 连接的首字节来区分不同协议：

| 首字节 | 协议 | 处理方式 |
|--------|------|----------|
| `0x16` | TLS Handshake | TLS 解密 → VLESS 解码 |
| `GET`/`POST` 等 | HTTP | 直接处理（监控页面） |
| `0x00`/`0x01` | VLESS | 直接解码（明文） |

#### 混合模式支持
- 单个端口同时支持 TLS-VLESS 和 Plain-HTTP
- TLS 连接用于 VLESS 加密传输
- 明文 HTTP 用于监控页面访问
- 自动协议检测，无需额外配置

### 🐛 问题修复

#### 修复 VLESS URL 自签名证书问题
- 之前：生成的 URL 不包含 `allowInsecure` 参数
- 现在：自动添加 `allowInsecure=true` 参数（v2rayN 需要导入后手动设置）
- 同时包含 `sni=<server_name>` 参数用于 TLS 握手

#### 移除证书嵌入功能
- 删除 `read_certificate_to_base64()` 方法
- 删除 `generate_cert_in_memory()` 函数
- 删除 `load_tls_config_from_bytes()` 函数
- 统一使用文件证书模式

### 📊 代码质量

- ✅ 完整的文档注释
- ✅ 清晰的错误处理（使用 `anyhow::Context`）
- ✅ 用户体验良好（分步引导）
- ✅ 输入验证完整（端口、UUID）
- ✅ 代码可维护性高

### 🎉 总结

本次更新大幅简化了 TLS 配置流程，提供了更好的用户体验：

1. **首次配置更简单**：交互式向导引导用户完成配置
2. **证书管理更智能**：自动生成，持久保存
3. **连接更便捷**：URL 自动生成，控制台打印
4. **代码更简洁**：移除不必要的模式，统一逻辑
