# 2026.02.02 - 流量监控逻辑修复与用户统计增强

## 更新内容

### 后端修复与增强

#### 修复
- **流量统计方向修复**：明确 upload/download 语义
  - `upload` = 客户端发送的数据（服务器接收）
  - `download` = 客户端接收的数据（服务器发送）
- **重复统计修复**：解决 initial_data 被 tokio::io::copy 重复读取的问题
  - 改用两个独立的 `tokio::spawn` 任务处理双向转发
  - 使用 `into_split()` 避免重复读取

#### 新增
- **用户级流量统计**：支持按 UUID 分组统计用户流量
  - 新增 `UserStats` 结构体（uuid, email, 流量数据, 连接数）
  - 新增 `UserMonitorData` API 响应结构
  - 新增 `/api/user-stats` 端点
- **数据持久化扩展**：配置文件支持用户级数据保存
  - `monitor.users` 结构存储各用户流量统计
  - 兼容旧字段名（`total_bytes_sent` → `total_upload_bytes`）

### 前端新增

#### 新增组件
- **UserStats.vue**：用户流量统计表格组件
  - 显示 UUID、邮箱、总流量、连接数
  - 支持按各列排序
  - 响应式设计

#### 功能增强
- **useWebSocket**：添加 `userStats` 状态管理
  - 实时接收用户流量数据
  - 自动更新用户统计表格

### API 变更

#### 新增端点
- `GET /api/user-stats`：获取所有用户流量统计

#### 修改响应
- `GET /api/stats`：响应新增 `users` 字段（用户统计数组）

#### 配置文件格式
```json
{
  "monitor": {
    "total_upload_bytes": 0,        // 新命名（原 total_bytes_sent）
    "total_download_bytes": 0,      // 新命名（原 total_bytes_received）
    "last_update": "2026-02-02T00:00:00Z",
    "users": {                       // 新增
      "uuid-string": {
        "total_upload_bytes": 0,
        "total_download_bytes": 0,
        "email": "user@example.com"
      }
    }
  }
}
```

## 技术细节

### 代码文件变更

**后端 (src/)**
- `stats.rs`：重构流量统计逻辑，添加用户级统计
- `server.rs`：修复 `handle_tcp_proxy` 流量统计问题
- `http.rs`：添加 `/api/user-stats` 路由

**前端 (frontend/src/)**
- `composables/useWebSocket.js`：添加用户数据状态
- `components/UserStats.vue`：新增用户统计组件
- `App.vue`：集成 UserStats 组件
