# 2026-02-06 - 依赖优化和IP检测增强

## 新增功能

### 配置灵活性
- 在 `config.json` 的 `server` 节点新增 `public_ip` 字段
- 支持手动指定公网 IP，跳过自动检测
- 适用于无法访问外网 API 的环境

### IP检测优化
- 简化为 3 个 IPv4 专用 API（`ipv4.icanhazip.com`、`checkip.amazonaws.com`、`v4.ident.me`）
- 只接受 IPv4 地址，自动过滤 IPv6
- 提供详细的故障诊断信息
- 超时从 10 秒优化到 8 秒

## 优化改进

### 依赖更新
- `reqwest` 从 `rustls-tls` 切换到 `native-tls`
- 提升网络兼容性，避免证书验证问题

### 代码安全性
- `src/base64.rs`: 移除 `unsafe` 代码，使用 `String::from_utf8()`
- 符合 Rust 最小权限原则

### 邮箱验证
- `src/wizard.rs`: 改进邮箱格式验证逻辑
- 检查 `@` 和 `.` 位置关系
- 拒绝明显无效格式（`@example.com`、`user@`、`user@.`）

### 日志增强
- `src/memory.rs`: 使用 `tracing::warn!` 和 `tracing::error!`
- 详细的错误信息，便于故障排查

### 平台支持调整
- `src/memory.rs`: 移除 macOS 支持代码
- 专注于 Linux/Windows 平台

## 文档更新

- `README.md`: 更新 IP 检测说明和 `public_ip` 配置项
- `docs/technology.md`: 更新依赖说明，添加新模块文档
- `CLAUDE.md`: 更新模块职责说明

## 修改文件

**后端代码**:
- `src/config.rs`: 新增 `public_ip` 配置字段
- `src/utils.rs`: IP 检测逻辑优化，IPv4 验证
- `src/main.rs`: 支持配置文件指定 IP
- `src/base64.rs`: 移除 unsafe 代码
- `src/memory.rs`: 移除 macOS 支持，增强日志
- `src/time.rs`: 负时间戳边界处理
- `src/wizard.rs`: 邮箱验证增强

**配置和依赖**:
- `Cargo.toml`: reqwest 使用 native-tls
- `config.json`: 时间戳格式更新

**文档**:
- `README.md`: 功能说明更新
- `docs/technology.md`: 技术文档更新
- `CLAUDE.md`: 项目规则更新
