# 2026-02-05 外网IP自动获取和VLESS链接生成

## 新增功能

### 交互式配置向导
- 首次运行时自动启动配置向导，引导用户完成初始化
- 支持交互式配置监听地址、端口、用户 UUID 和邮箱
- UUID 支持自动生成（推荐）或手动输入
- 支持添加多个用户，每个用户独立配置
- 自动验证输入格式（IP 地址、端口、UUID、邮箱）
- 配置完成后自动生成 `config.json` 文件
- 友好的中文界面和错误提示

### 外网 IP 自动获取
- 服务器启动时自动检测外网 IP 地址
- 并发请求多个 API，任一成功即返回
- 支持 5 个备用 API 服务（api.ipify.org、icanhazip.com、checkip.amazonaws.com、ifconfig.me、ipecho.net/plain）
- 单 API 5 秒超时，整体 10 秒超时
- 检测失败时使用 `YOUR_SERVER_IP` 占位符，不影响服务器启动

### VLESS 链接自动生成
- 为每个用户自动生成完整的 VLESS:// 协议链接
- 链接别名格式：
  - 有邮箱用户：`IP+邮箱`（URL 编码，例如：`123.45.67.89%2Buser%40example.com`）
  - 无邮箱用户：`IP+UUID前8位`（例如：`123.45.67.89%2B615767da`）
- 协议参数：`encryption=none&security=none&type=tcp`
- 启动日志中打印所有用户的连接链接，可直接复制到客户端导入

## 修改文件

### 新增文件
- `src/utils.rs` - 工具函数模块，包含 IP 检测和 VLESS URL 生成逻辑
  - `get_public_ip()` - 并发请求多个 API 获取外网 IP
  - `generate_vless_url()` - 生成标准 VLESS 协议链接
  - `fetch_ip_from_api()` - 从单个 API 获取 IP
  - `validate_ip()` - 验证 IPv4 格式
  - `url_encode()` - URL 编码函数
- `src/wizard.rs` - 交互式配置向导模块
  - `ConfigWizard` - 配置向导结构体
  - `run()` - 启动向导主流程
  - `prompt_listen_address()` - 配置监听地址
  - `prompt_port()` - 配置监听端口
  - `prompt_users()` - 配置用户列表
  - `prompt_user()` - 配置单个用户

### 修改文件
- `Cargo.toml` - 添加 `reqwest = { version = "0.11", default-features = false, features = ["rustls-tls"] }` 依赖
- `src/main.rs` - 集成 IP 检测和链接生成功能，在启动前打印连接信息
- `docs/technology.md` - 更新技术栈和文件映射关系

## 技术细节

### 配置向导实现
- **标准输入/输出**: 使用 `std::io` 处理用户交互
- **输入验证**: 循环验证直到输入合法或接受默认值
- **错误处理**: 使用 `anyhow::Result` 统一错误处理
- **用户友好**: 提供详细的提示信息和选项说明
- **UUID 生成**: 使用 `uuid::Uuid::new_v4()` 生成安全的随机 UUID
- **格式化输出**: 使用 Unicode 字符绘制边框和分隔线

### 依赖项
- **reqwest 0.11**: 异步 HTTP 客户端，使用 rustls-tls 减少二进制体积
- **并发请求**: 使用 `futures_util::future::join_all()` 并发请求所有 API
- **超时控制**: Tokio `timeout()` 包裹整体请求，避免长时间阻塞

### 性能影响
- **启动时间**: 增加 100-300ms（API 快速响应时）
- **二进制体积**: 增加约 2MB（从 974KB → 3.0MB，含 LTO 优化）
- **运行时内存**: 增加 1-2MB（HTTP 客户端连接池）

### 单元测试
- `test_generate_vless_url_with_email` - 测试带邮箱的链接生成
- `test_generate_vless_url_without_email` - 测试无邮箱的链接生成
- `test_url_encode` - 测试 URL 编码功能
- `test_validate_ip` - 测试 IP 格式验证

## 使用示例

### 配置向导交互流程
```
[INFO] Config file not found at config.json
[INFO] Starting configuration wizard...

╔════════════════════════════════════════════════════════════╗
║         VLESS Server - 首次配置向导                        ║
║                                                            ║
║  欢迎使用 VLESS 服务器！                                   ║
║  这个向导将帮助您完成基本配置。                            ║
╚════════════════════════════════════════════════════════════╝

【服务器监听地址】
  监听地址决定了服务器接受连接的网络接口。
  • 0.0.0.0  - 监听所有网络接口（推荐）
  • 127.0.0.1 - 仅本地访问
  • 特定IP   - 仅指定网卡
  请输入监听地址 [默认: 0.0.0.0]: [直接回车]

【服务器监听端口】
  监听端口用于接受 VLESS 连接和 HTTP 监控请求。
  常用端口：443 (HTTPS)、8443 (备用HTTPS)
  请输入端口 [1-65535，默认: 443]: 8443

【用户配置】
  VLESS 协议使用 UUID 作为用户认证凭据。
  每个用户需要唯一的 UUID 和可选的邮箱地址。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
添加用户 #1
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【用户 UUID】
  UUID 是用户的唯一认证凭据，必须保密。
  • 自动生成 - 系统随机生成安全的 UUID（推荐）
  • 手动输入 - 使用自定义 UUID（8-4-4-4-12 格式）
  选择 [A]自动生成 / [M]手动输入 [默认: A]: [直接回车]
  ✓ 已生成 UUID: 615767da-4db9-4df7-9f12-d7d617fc1d96

【用户邮箱】（可选）
  邮箱地址用于标识用户，方便管理。
  可以在客户端显示，帮助识别连接。
  请输入邮箱地址（直接回车跳过）: user@example.com

✓ 用户配置完成
  UUID: 615767da-4db9-4df7-9f12-d7d617fc1d96
  Email: user@example.com

当前用户数: 1
是否继续添加用户？[y/N]: n

✓ 配置完成！正在生成配置文件...
[INFO] Config saved to config.json
```

### 成功获取 IP 时输出
```
[INFO] Detecting public IP...
[INFO] Public IP: 123.182.3.236
[INFO]
[INFO] ========== VLESS Connection Links ==========
[INFO] vless://615767da-4db9-4df7-9f12-d7d617fc1d96@123.182.3.236:8443?encryption=none&security=none&type=tcp#123.182.3.236%2Buser1%40example.com
[INFO] ==========================================
```

### 无法获取 IP 时输出
```
[INFO] Detecting public IP...
[WARN] Failed to detect public IP: all attempts failed
[INFO]
[INFO] ========== VLESS Connection Links ==========
[INFO] Please replace YOUR_SERVER_IP with your actual public IP:
[INFO] vless://615767da-4db9-4df7-9f12-d7d617fc1d96@YOUR_SERVER_IP:8443?encryption=none&security=none&type=tcp#YOUR_SERVER_IP%2Buser1%40example.com
[INFO] ==========================================
```

### 多用户场景输出
```
[INFO] ========== VLESS Connection Links ==========
[INFO] vless://615767da-4db9-4df7-9f12-d7d617fc1d96@123.182.3.236:8443?encryption=none&security=none&type=tcp#123.182.3.236%2Buser1%40example.com
[INFO] vless://aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee@123.182.3.236:8443?encryption=none&security=none&type=tcp#123.182.3.236%2Buser2%40example.com
[INFO] vless://11111111-2222-3333-4444-555555555555@123.182.3.236:8443?encryption=none&security=none&type=tcp#123.182.3.236%2B11111111
[INFO] ==========================================
```

## 验证步骤

1. **测试配置向导**:
   - 备份现有配置：`cp config.json config.json.bak`
   - 删除配置文件：`rm config.json`
   - 运行程序：`cargo run`
   - 按照向导提示完成配置
   - 验证生成的 `config.json` 格式正确
2. 编译项目：`cargo build`
3. 运行测试：`cargo test utils`
4. 启动服务器：`cargo run`
5. 验证日志输出中的 VLESS 链接格式正确
6. 复制链接到 VLESS 客户端测试连接

## 后续优化方向

1. **配置向导增强**:
   - 支持高级配置选项（性能参数、监控设置）
   - 添加配置文件迁移功能（版本升级）
   - 支持编辑现有配置而非重新生成
   - 添加配置验证和建议
2. **后台异步获取**: 将 IP 检测改为后台任务，不阻塞服务器启动
3. **配置化支持**: 在 `config.json` 中支持手动指定 IP 地址
4. **前端集成**: 通过 WebSocket 推送到监控页面展示
5. **IPv6 支持**: 同时检测和展示 IPv6 地址
6. **二维码生成**: 生成 VLESS 链接的二维码便于移动端扫码导入

---

## 代码审查与修复 (2026-02-06)

### 审查结果

对新增模块 `utils.rs` 和 `wizard.rs` 进行了全面代码审查，发现并修复了以下问题：

**高优先级修复 (已修复):**

1. **UUID 重复验证逻辑** (`src/wizard.rs:199-202`)
   - **问题**: 只警告但允许添加重复 UUID，导致运行时认证问题
   - **修复**: 改为阻止重复 UUID，要求用户重新输入
   - **影响**: 确保每个用户 UUID 唯一性

2. **IP 验证不支持 IPv6** (`src/utils.rs:102-113`)
   - **问题**: 只验证 IPv4 格式，API 返回 IPv6 会被拒绝
   - **修复**: 使用标准库 `std::net::IpAddr` 验证，同时支持 IPv4 和 IPv6
   - **影响**: 扩展 IP 检测能力，为 IPv6 支持做准备

**中优先级修复 (已修复):**

3. **URL 编码标准化** (`src/utils.rs:124`)
   - **问题**: 使用大写十六进制 `%2X`，不符合 RFC 3986 标准
   - **修复**: 改为小写十六进制 `%2x`
   - **影响**: 提高协议兼容性

4. **IP 检测错误信息改进** (`src/utils.rs:33-40`)
   - **问题**: 所有 API 失败时只显示 "all attempts failed"
   - **修复**: 收集并显示第一个错误的详细信息
   - **影响**: 便于调试和排查网络问题

5. **测试用例更新** (`src/utils.rs:137-164`)
   - **问题**: URL 编码改为小写后测试断言失败
   - **修复**: 更新测试用例的预期值，添加 IPv6 测试
   - **影响**: 确保测试覆盖率和准确性

### 测试结果

所有测试通过：
```
running 6 tests
test config::tests::test_udp_config_defaults ... ok
test utils::tests::test_validate_ip ... ok           # 现在支持 IPv6
test config::tests::test_config_serialization ... ok
test utils::tests::test_generate_vless_url_without_email ... ok
test utils::tests::test_url_encode ... ok
test utils::tests::test_generate_vless_url_with_email ... ok

test result: ok. 6 passed; 0 failed
```

### 代码质量亮点

- ✅ 良好的错误处理（使用 `anyhow::Result` 和 `.context()`）
- ✅ 完善的单元测试覆盖（4 个测试用例）
- ✅ 清晰的代码组织和模块化设计
- ✅ 用户友好的交互界面
- ✅ 安全的依赖选择（rustls-tls）
- ✅ UUID 生成使用密码学安全算法

### 已知问题（可选改进）

- **邮箱验证过于宽松**: 当前只检查 `@` 和 `.`，建议使用正则表达式
- **非交互环境不支持**: 向导在无 TTY 环境会失败（systemd 服务等）
- **HTTP 客户端连接池**: 当前未配置池大小（对启动时检测影响不大）
- **wizard.rs 测试覆盖**: 由于涉及交互输入，测试较复杂

### 文档更新

- ✅ `docs/2026-02-05-*.md` - 新增代码审查与修复章节
- ✅ `CLAUDE.md` - 已包含 utils.rs 和 wizard.rs 映射
- ✅ `docs/technology.md` - 已更新技术栈和文件映射

